System.register(["jimu-core","jimu-arcgis"],(function(e,t){var r={},n={};return{setters:[function(e){r.DataSourceComponent=e.DataSourceComponent,r.React=e.React,r.getAppStore=e.getAppStore,r.jsx=e.jsx},function(e){n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules}],execute:function(){e((()=>{var e={826:e=>{"use strict";e.exports=n},891:e=>{"use strict";e.exports=r}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var a={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(a),o.d(a,{__set_webpack_public_path__:()=>i,default:()=>n});var e=o(891),t=o(826),r=function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{c(n.next(e))}catch(e){a(e)}}function u(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))};function n(n){var o;const{username:a,fullName:i,lastLogin:u,role:c,created:s}=n.user,{name:d,title:l,id:p,type:f,owner:v}=(0,e.getAppStore)().getState().appInfo,m=null===(o=n.useDataSources)||void 0===o?void 0:o[0],g=e.React.useRef(),[y,w]=e.React.useState(!1),S=e.React.useRef({duration:0}),h=e.React.useRef(),D=e.React.useRef(),R=e.React.useRef();var b=1;const E=()=>r(this,void 0,void 0,(function*(){try{const e=(yield g.current.applyEdits({addFeatures:[{geometry:{type:"point",x:0,y:0,spatialReference:{wkid:4326}},attributes:{portalname:n.config.portalName||d||l,username:a,fullname:i||"",datestr:new Date(u).toLocaleString("ru-RU"),dateint:Math.floor(new Date(u).getTime()/1e3),dateinstr:(new Date).toLocaleString("ru-RU"),dateinint:Math.floor((new Date).getTime()/1e3),dateoutstr:"0",dateoutint:0,duration:S.current.duration,role:c||"custom",createdstr:new Date(s).toLocaleString("ru-RU"),createdint:Math.floor(new Date(s).getTime()/1e3),portaltype:f,portalid:p,portalowner:v}}]})).addFeatureResults[0];if(e.error)throw new Error(e.error.message);return e.objectId}catch(e){console.error("Ошибка:",e),console.error("Ошибка: "+(e.message||"Неизвестная ошибка"))}}));return e.React.useEffect((()=>r(this,void 0,void 0,(function*(){const e=()=>{b=1,clearTimeout(h.current),h.current=setTimeout((()=>b=0),5e3)},t=()=>r(this,void 0,void 0,(function*(){document.hidden?(b=0,clearTimeout(h.current),S.current.dateoutstr=(new Date).toLocaleString("ru-RU"),S.current.dateoutint=Math.floor((new Date).getTime()/1e3)):(b=1,e(),S.current.dateinstr=(new Date).toLocaleString("ru-RU"),S.current.dateinint=Math.floor((new Date).getTime()/1e3))}));t();var n=["mousedown","mousemove","keypress","scroll"];return n.forEach((t=>document.addEventListener(t,e))),document.addEventListener("visibilitychange",t),window.addEventListener("beforeunload",(e=>{S.current.dateoutstr=(new Date).toLocaleString("ru-RU"),S.current.dateoutint=Math.floor((new Date).getTime()/1e3),g.current.applyEdits({updateFeatures:[{attributes:S.current}]}),e.preventDefault(),e.returnValue=""})),D.current=setInterval((()=>{S.current.duration+=b}),1e3),R.current=setInterval((()=>r(this,void 0,void 0,(function*(){yield g.current.applyEdits({updateFeatures:[{attributes:S.current}]})}))),1e4),()=>r(this,void 0,void 0,(function*(){n.forEach((t=>document.removeEventListener(t,e))),document.removeEventListener("visibilitychange",t),clearTimeout(h.current),clearInterval(D.current),clearInterval(R.current)}))}))),[]),(0,e.jsx)(e.DataSourceComponent,{useDataSource:m,onDataSourceCreated:e=>r(this,void 0,void 0,(function*(){var o;const[i]=yield(0,t.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]),u=(null===(o=e.getUrl)||void 0===o?void 0:o.call(e))||e.url;if(!u)throw new Error("URL слоя не найден");g.current=new i({url:u}),w(!0),yield e.query({where:`portalname = '${n.config.portalName||d||l}' AND username = '${a}' AND datestr LIKE '${(new Date).toLocaleDateString()}%'`,outFields:["objectid","dateinint","dateinstr","dateoutint","dateoutstr","duration"],returnGeometry:!0,orderByFields:["dateoutint DESC","dateinint DESC"]}).then((e=>r(this,void 0,void 0,(function*(){e.records.length?(S.current=Object.assign({},e.records[0].getData()),S.current.dateinstr=(new Date).toLocaleString("ru-RU"),S.current.dateinint=Math.floor((new Date).getTime()/1e3),yield g.current.applyEdits({updateFeatures:[{attributes:S.current}]})):E()}))))}))})}function i(e){o.p=e}})(),a})())}}}));