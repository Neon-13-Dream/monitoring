System.register(["jimu-core","jimu-arcgis"],(function(t,e){var r={},n={};return{setters:[function(t){r.DataSourceComponent=t.DataSourceComponent,r.React=t.React,r.getAppStore=t.getAppStore,r.jsx=t.jsx},function(t){n.loadArcGISJSAPIModules=t.loadArcGISJSAPIModules}],execute:function(){t((()=>{var t={826:t=>{"use strict";t.exports=n},891:t=>{"use strict";t.exports=r}},e={};function o(r){var n=e[r];if(void 0!==n)return n.exports;var a=e[r]={exports:{}};return t[r](a,a.exports,o),a.exports}o.d=(t,e)=>{for(var r in e)o.o(e,r)&&!o.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.p="";var a={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(a),o.d(a,{__set_webpack_public_path__:()=>i,default:()=>n});var t=o(891),e=o(826),r=function(t,e,r,n){return new(r||(r=Promise))((function(o,a){function i(t){try{c(n.next(t))}catch(t){a(t)}}function u(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,u)}c((n=n.apply(t,e||[])).next())}))};function n(n){var o;const{username:a,fullName:i,lastLogin:u,role:c,created:l}=n.user,{id:d,type:s,owner:p}=(0,t.getAppStore)().getState().appInfo||{},f=null===(o=n.useDataSources)||void 0===o?void 0:o[0],v=t.React.useRef(null),[g,y]=t.React.useState(!1),w=new Date,S=t.React.useRef({durationint:0}),m=t.React.useRef(null),h=t.React.useRef(null),D=t.React.useRef(!1),R=t.React.useRef(!0);var b=1;const L=(e=5e3,n=100)=>r(this,void 0,void 0,(function*(){const r=Date.now();for(;Date.now()-r<e;){const e=(0,t.getAppStore)().getState().appInfo;if(e&&Object.keys(e).length)return e;yield new Promise((t=>setTimeout(t,n)))}return(0,t.getAppStore)().getState().appInfo})),M=(t,e,n)=>r(this,void 0,void 0,(function*(){const r=yield t.query({where:`portalname = '${e}' AND username = '${n}' AND datestr LIKE '${w.toLocaleDateString("ru-RU")}%'`,outFields:["objectid","dateinint","dateinstr","lastactint","lastactstr","durationint"],returnGeometry:!0,orderByFields:["lastactint DESC","dateinint DESC"]});return r&&r.records&&r.records.length?r.records[0].getData():null})),E=(t,e)=>r(this,void 0,void 0,(function*(){var r;if(!v.current)return;const n=yield M(t,e,a);if(n)return S.current=Object.assign({},n),n.objectid||null;const o=new Date(u),f=new Date(o.getFullYear(),o.getMonth(),o.getDate()),g=Math.floor(f.getTime()/1e3),y=3600*o.getHours()+60*o.getMinutes()+o.getSeconds(),m=Math.floor(o.getTime()/1e3),h=new Date(l),D=Math.floor(h.getTime()/1e3),R=yield v.current.applyEdits({addFeatures:[{geometry:{type:"point",x:0,y:0,spatialReference:{wkid:4326}},attributes:{portalname:e,username:a,fullname:i||"",datestr:o.toLocaleDateString("ru-RU"),dateint:g,timestr:o.toLocaleTimeString("ru-RU"),timeint:y,dateinstr:w.toLocaleString("ru-RU"),dateinint:m,lastactstr:w.toLocaleString("ru-RU"),lastactint:m,durationint:S.current.durationint,durationstr:`${S.current.durationint}`,role:c||"custom",createdstr:h.toLocaleString("ru-RU"),createdint:D,portaltype:s,portalid:d,portalowner:p}}]}),b=null===(r=null==R?void 0:R.addFeatureResults)||void 0===r?void 0:r[0];if(null==b?void 0:b.error)throw new Error(b.error.message);return(null==b?void 0:b.objectId)||null}));return t.React.useEffect((()=>{if(R.current=!0,!g)return;b=1;const t=()=>r(this,void 0,void 0,(function*(){R.current&&v.current&&(document.hidden?(b=0,S.current.lastactstr=(new Date).toLocaleString("ru-RU"),S.current.lastactint=Math.floor(Date.now()/1e3)):(b=1,S.current.dateinstr=(new Date).toLocaleString("ru-RU"),S.current.dateinint=Math.floor(Date.now()/1e3)),yield v.current.applyEdits({updateFeatures:[{attributes:S.current}]}))}));document.addEventListener("visibilitychange",t);const e=t=>r(this,void 0,void 0,(function*(){v.current&&(S.current.lastactint=(new Date).toLocaleString("ru-RU"),S.current.dateoutint=Math.floor(Date.now()/1e3),yield v.current.applyEdits({updateFeatures:[{attributes:S.current}]}),t.preventDefault(),t.returnValue="")}));return window.addEventListener("befoeunload",e),window.addEventListener("unload",e),t(),m.current=setInterval((()=>r(this,void 0,void 0,(function*(){R.current&&(!b&&S.current.durationint<5&&(S.current.durationstr=new Date(S.current.durationint).toLocaleTimeString("ru-RU"),yield v.current.applyEdits({updateFeatures:[{attributes:S.current}]})),S.current.durationint+=b)}))),1e3),h.current=setInterval((()=>r(this,void 0,void 0,(function*(){R.current&&v.current&&(S.current.durationstr=`${Math.floor(S.current.durationint/3600)>0?Math.floor(S.current.durationint/3600)+":":""}${Math.floor(S.current.durationint/60%60)>0?Math.floor(S.current.durationint/60%60)+":":""}${Math.floor(S.current.durationint%60)}`,yield v.current.applyEdits({updateFeatures:[{attributes:S.current}]}))}))),1e4),()=>{R.current=!1,clearInterval(m.current),clearInterval(h.current),document.removeEventListener("visibilitychange",t),window.removeEventListener("beforeunload",e),window.removeEventListener("unload",e)}}),[g]),(0,t.jsx)(t.DataSourceComponent,{useDataSource:f,onDataSourceCreated:t=>r(this,void 0,void 0,(function*(){var r;if(D.current)return;D.current=!0;const o=yield L(5e3,100),i=n.config.portalName||(null==o?void 0:o.name)||(null==o?void 0:o.title)||"unknown_portal",[u]=yield(0,e.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]),c=(null===(r=t.getUrl)||void 0===r?void 0:r.call(t))||t.url;if(!c)throw new Error("URL слоя не найден");v.current=new u({url:c});const l=yield M(t,i,a);l?(S.current=Object.assign({},l),S.current.dateinstr=(new Date).toLocaleString("ru-RU"),S.current.dateinint=Math.floor(Date.now()/1e3),v.current&&(yield v.current.applyEdits({updateFeatures:[{attributes:S.current}]}))):yield E(t,i),y(!0),D.current=!1}))})}function i(t){o.p=t}})(),a})())}}}));