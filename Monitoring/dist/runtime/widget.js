System.register(["jimu-core","jimu-arcgis"],(function(e,t){var r={},n={};return{setters:[function(e){r.DataSourceComponent=e.DataSourceComponent,r.React=e.React,r.getAppStore=e.getAppStore,r.jsx=e.jsx},function(e){n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules}],execute:function(){e((()=>{var e={826:e=>{"use strict";e.exports=n},891:e=>{"use strict";e.exports=r}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var a={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(a),o.d(a,{__set_webpack_public_path__:()=>u,default:()=>n});var e=o(891),t=o(826),r=function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function u(e){try{c(n.next(e))}catch(e){a(e)}}function i(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,i)}c((n=n.apply(e,t||[])).next())}))};function n(n){var o;const{username:a,fullName:u,lastLogin:i,role:c,created:l}=n.user,{name:s,title:d,id:f,type:p,owner:v}=(0,e.getAppStore)().getState().appInfo||{},y=null===(o=n.useDataSources)||void 0===o?void 0:o[0],w=e.React.useRef(null),[m,g]=e.React.useState(!1),h=e.React.useRef({duration:0}),S=e.React.useRef(null),D=e.React.useRef(null),R=e.React.useRef(null),b=e.React.useRef(!1),E=e.React.useRef(!0);let L=1;const j=(t=5e3,n=100)=>r(this,void 0,void 0,(function*(){const r=Date.now();for(;Date.now()-r<t;){const t=(0,e.getAppStore)().getState().appInfo;if(t&&Object.keys(t).length)return t;yield new Promise((e=>setTimeout(e,n)))}return(0,e.getAppStore)().getState().appInfo})),I=(e,t,n)=>r(this,void 0,void 0,(function*(){try{const r=(new Date).toLocaleDateString("ru-RU"),o=yield e.query({where:`portalname = '${t}' AND username = '${n}' AND datestr LIKE '${r}%'`,outFields:["objectid","dateinint","dateinstr","dateoutint","dateoutstr","duration"],returnGeometry:!0,orderByFields:["dateoutint DESC","dateinint DESC"]});return o&&o.records&&o.records.length?o.records[0].getData():null}catch(e){return console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏:",e),null}})),x=(e,t)=>r(this,void 0,void 0,(function*(){var r;if(!w.current)return void console.warn("‚ö†Ô∏è featureLayer –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî addNewFeatures –ø—Ä–æ–ø—É—â–µ–Ω");const n=yield I(e,t,a);if(n)return console.log("–ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º addNewFeatures"),h.current=Object.assign({},n),n.objectid||null;try{const e=yield w.current.applyEdits({addFeatures:[{geometry:{type:"point",x:0,y:0,spatialReference:{wkid:4326}},attributes:{portalname:t,username:a,fullname:u||"",datestr:new Date(i).toLocaleString("ru-RU"),dateint:Math.floor(new Date(i).getTime()/1e3),dateinstr:(new Date).toLocaleString("ru-RU"),dateinint:Math.floor(Date.now()/1e3),dateoutstr:"0",dateoutint:0,duration:h.current.duration,role:c||"custom",createdstr:new Date(l).toLocaleString("ru-RU"),createdint:Math.floor(new Date(l).getTime()/1e3),portaltype:p,portalid:f,portalowner:v}}]}),n=null===(r=null==e?void 0:e.addFeatureResults)||void 0===r?void 0:r[0];if(null==n?void 0:n.error)throw new Error(n.error.message);return console.log("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),(null==n?void 0:n.objectId)||null}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏:",(null==e?void 0:e.message)||e)}}));return e.React.useEffect((()=>{if(E.current=!0,!m)return;L=1;const e=()=>{E.current&&(L=1,clearTimeout(S.current),S.current=setTimeout((()=>r(this,void 0,void 0,(function*(){if(E.current&&w.current){L=0,h.current.duration=Math.max(0,h.current.duration-4),h.current.dateoutstr=(new Date).toLocaleString("ru-RU"),h.current.dateoutint=Math.floor(Date.now()/1e3);try{yield w.current.applyEdits({updateFeatures:[{attributes:h.current}]})}catch(e){console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ inactivity timeout:",e)}}}))),5e3))},t=()=>r(this,void 0,void 0,(function*(){if(E.current&&w.current){document.hidden?(L=0,clearTimeout(S.current),h.current.dateoutstr=(new Date).toLocaleString("ru-RU"),h.current.dateoutint=Math.floor(Date.now()/1e3)):(L=1,e(),h.current.dateinstr=(new Date).toLocaleString("ru-RU"),h.current.dateinint=Math.floor(Date.now()/1e3));try{yield w.current.applyEdits({updateFeatures:[{attributes:h.current}]})}catch(e){console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ visibilityChange:",e)}}})),n=["mousedown","mousemove","keypress","scroll"];n.forEach((t=>document.addEventListener(t,e))),document.addEventListener("visibilitychange",t);const o=e=>r(this,void 0,void 0,(function*(){if(w.current){h.current.dateoutstr=(new Date).toLocaleString("ru-RU"),h.current.dateoutint=Math.floor(Date.now()/1e3);try{yield w.current.applyEdits({updateFeatures:[{attributes:h.current}]})}catch(e){console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ beforeunload applyEdits:",e)}e.preventDefault(),e.returnValue=""}}));return window.addEventListener("beforeunload",o),t(),D.current=setInterval((()=>{E.current&&(h.current.duration+=L)}),1e3),R.current=setInterval((()=>r(this,void 0,void 0,(function*(){if(E.current&&w.current)try{yield w.current.applyEdits({updateFeatures:[{attributes:h.current}]})}catch(e){console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–≤–æ–∑–º–æ–∂–Ω–æ, –≤–∏–¥–∂–µ—Ç —É–¥–∞–ª—ë–Ω)")}}))),1e4),()=>{E.current=!1,clearInterval(D.current),clearInterval(R.current),clearTimeout(S.current),n.forEach((t=>document.removeEventListener(t,e))),document.removeEventListener("visibilitychange",t),window.removeEventListener("beforeunload",o)}}),[m]),(0,e.jsx)(e.DataSourceComponent,{useDataSource:y,onDataSourceCreated:e=>r(this,void 0,void 0,(function*(){var r;if(b.current)console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤");else{b.current=!0;try{const o=yield j(5e3,100),u=n.config.portalName||(null==o?void 0:o.name)||(null==o?void 0:o.title)||"unknown_portal",[i]=yield(0,t.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]),c=(null===(r=e.getUrl)||void 0===r?void 0:r.call(e))||e.url;if(!c)throw new Error("URL —Å–ª–æ—è –Ω–µ –Ω–∞–π–¥–µ–Ω");w.current=new i({url:c});const l=yield I(e,u,a);if(l){if(console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω (–ø–æ—Å–ª–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)"),h.current=Object.assign({},l),h.current.dateinstr=(new Date).toLocaleString("ru-RU"),h.current.dateinint=Math.floor(Date.now()/1e3),w.current)try{yield w.current.applyEdits({updateFeatures:[{attributes:h.current}]})}catch(e){console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π:",e)}}else console.log("üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏) ‚Äî —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å"),yield x(e,u);g(!0)}catch(e){console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:",(null==e?void 0:e.message)||e)}finally{b.current=!1}}}))})}function u(e){o.p=e}})(),a})())}}}));