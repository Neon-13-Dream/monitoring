System.register(["jimu-core","jimu-arcgis"],(function(e,t){var r={},n={};return{setters:[function(e){r.DataSourceComponent=e.DataSourceComponent,r.React=e.React,r.getAppStore=e.getAppStore,r.jsx=e.jsx},function(e){n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules}],execute:function(){e((()=>{var e={826:e=>{"use strict";e.exports=n},891:e=>{"use strict";e.exports=r}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var a=t[r]={exports:{}};return e[r](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var a={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(a),o.d(a,{__set_webpack_public_path__:()=>u,default:()=>n});var e=o(891),t=o(826),r=function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function u(e){try{c(n.next(e))}catch(e){a(e)}}function i(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,i)}c((n=n.apply(e,t||[])).next())}))};function n(n){var o;const{username:a,fullName:u,lastLogin:i,role:c,created:d}=n.user,{id:l,type:s,owner:p}=(0,e.getAppStore)().getState().appInfo||{},f=null===(o=n.useDataSources)||void 0===o?void 0:o[0],v=e.React.useRef(null),[w,y]=e.React.useState(!1),g=e.React.useRef({duration:0}),S=e.React.useRef(null),m=e.React.useRef(null),D=e.React.useRef(!1),h=e.React.useRef(!0);let R=1;const b=(t=5e3,n=100)=>r(this,void 0,void 0,(function*(){const r=Date.now();for(;Date.now()-r<t;){const t=(0,e.getAppStore)().getState().appInfo;if(t&&Object.keys(t).length)return t;yield new Promise((e=>setTimeout(e,n)))}return(0,e.getAppStore)().getState().appInfo})),L=(e,t,n)=>r(this,void 0,void 0,(function*(){const r=(new Date).toLocaleDateString("ru-RU"),o=yield e.query({where:`portalname = '${t}' AND username = '${n}' AND datestr LIKE '${r}%'`,outFields:["objectid","dateinint","dateinstr","dateoutint","dateoutstr","duration"],returnGeometry:!0,orderByFields:["dateoutint DESC","dateinint DESC"]});return o&&o.records&&o.records.length?o.records[0].getData():null})),E=(e,t)=>r(this,void 0,void 0,(function*(){var r;if(!v.current)return;const n=yield L(e,t,a);if(n)return g.current=Object.assign({},n),n.objectid||null;const o=yield v.current.applyEdits({addFeatures:[{geometry:{type:"point",x:0,y:0,spatialReference:{wkid:4326}},attributes:{portalname:t,username:a,fullname:u||"",datestr:new Date(i).toLocaleString("ru-RU"),dateint:Math.floor(new Date(i).getTime()/1e3),dateinstr:(new Date).toLocaleString("ru-RU"),dateinint:Math.floor(Date.now()/1e3),dateoutstr:(new Date).toLocaleString("ru-RU"),dateoutint:Math.floor(Date.now()/1e3),duration:g.current.duration,role:c||"custom",createdstr:new Date(d).toLocaleString("ru-RU"),createdint:Math.floor(new Date(d).getTime()/1e3),portaltype:s,portalid:l,portalowner:p}}]}),f=null===(r=null==o?void 0:o.addFeatureResults)||void 0===r?void 0:r[0];if(null==f?void 0:f.error)throw new Error(f.error.message);return(null==f?void 0:f.objectId)||null}));return e.React.useEffect((()=>{if(h.current=!0,!w)return;R=1;const e=()=>r(this,void 0,void 0,(function*(){h.current&&v.current&&(document.hidden?(R=0,g.current.dateoutstr=(new Date).toLocaleString("ru-RU"),g.current.dateoutint=Math.floor(Date.now()/1e3)):(R=1,g.current.dateinstr=(new Date).toLocaleString("ru-RU"),g.current.dateinint=Math.floor(Date.now()/1e3)),yield v.current.applyEdits({updateFeatures:[{attributes:g.current}]}))}));document.addEventListener("visibilitychange",e);const t=e=>r(this,void 0,void 0,(function*(){v.current&&(g.current.dateoutstr=(new Date).toLocaleString("ru-RU"),g.current.dateoutint=Math.floor(Date.now()/1e3),yield v.current.applyEdits({updateFeatures:[{attributes:g.current}]}),e.preventDefault(),e.returnValue="")}));return window.addEventListener("befoeunload",t),window.addEventListener("unload",t),e(),S.current=setInterval((()=>r(this,void 0,void 0,(function*(){h.current&&(!R&&g.current.duration<5&&(g.current.dateoutstr=(new Date).toLocaleString("ru-RU"),g.current.dateoutint=Math.floor(Date.now()/1e3),yield v.current.applyEdits({updateFeatures:[{attributes:g.current}]})),g.current.duration+=R)}))),1e3),m.current=setInterval((()=>r(this,void 0,void 0,(function*(){h.current&&v.current&&(yield v.current.applyEdits({updateFeatures:[{attributes:g.current}]}))}))),1e4),()=>{h.current=!1,clearInterval(S.current),clearInterval(m.current),document.removeEventListener("visibilitychange",e),window.removeEventListener("beforeunload",t),window.removeEventListener("unload",t)}}),[w]),(0,e.jsx)(e.DataSourceComponent,{useDataSource:f,onDataSourceCreated:e=>r(this,void 0,void 0,(function*(){var r;if(D.current)return;D.current=!0;const o=yield b(5e3,100),u=n.config.portalName||(null==o?void 0:o.name)||(null==o?void 0:o.title)||"unknown_portal",[i]=yield(0,t.loadArcGISJSAPIModules)(["esri/layers/FeatureLayer"]),c=(null===(r=e.getUrl)||void 0===r?void 0:r.call(e))||e.url;if(!c)throw new Error("URL слоя не найден");v.current=new i({url:c});const d=yield L(e,u,a);d?(g.current=Object.assign({},d),g.current.dateinstr=(new Date).toLocaleString("ru-RU"),g.current.dateinint=Math.floor(Date.now()/1e3),v.current&&(yield v.current.applyEdits({updateFeatures:[{attributes:g.current}]}))):yield E(e,u),y(!0),D.current=!1}))})}function u(e){o.p=e}})(),a})())}}}));